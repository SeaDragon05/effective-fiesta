package main;

import java.io.UnsupportedEncodingException;
import java.util.List;

import javax.usb.*;

import org.usb4java.Loader;

public class test {
	public static void main(String[] args) throws SecurityException, UsbException {
		UsbServices usbServices = UsbHostManager.getUsbServices();
		UsbHub rootHub = usbServices.getRootUsbHub();
		for (UsbDevice device : (List<UsbDevice>) rootHub.getAttachedUsbDevices()) {
			System.out.println("Found a device! " + device.toString());
		}
		System.out.println("There are " + rootHub.getAttachedUsbDevices().size() + " devices connected");
		try {
			listConnectedDevices(rootHub, 0);
		} catch(Exception e) {
			e.printStackTrace();
		}
		// short NXT_DEVICE_ID = 8;
		// short NXT_PRODUCT_ID = (short) ((byte) 0x0694002);
		/*
		 * UsbDevice NXT = findDevice(rootHub, NXT_DEVICE_ID, NXT_PRODUCT_ID);
		 * 
		 * UsbInterface usbInterface =
		 * NXT.getActiveUsbConfiguration().getUsbInterface((byte) 0); UsbEndpoint
		 * endpoint = usbInterface.getUsbEndpoint((byte) 0x81); // Change the endpoint
		 * address accordingly
		 * 
		 * UsbPipe usbPipe = endpoint.getUsbPipe(); usbPipe.open();
		 * 
		 * byte[] data = Main.playTone(500, 100);
		 * 
		 * int sentBytes = usbPipe.syncSubmit(data);
		 * 
		 * System.out.println("Send the data to the NXT");
		 * 
		 * usbPipe.close();
		 */
	}

	private static void listConnectedDevices(UsbHub hub, int indent) throws UsbException, UnsupportedEncodingException {
		for (UsbDevice device : (List<UsbDevice>) hub.getAttachedUsbDevices()) {
			printDeviceInfo(device, indent);
			if (device.isUsbHub()) {
				listConnectedDevices((UsbHub) device, indent + 2);
			}
		}
	}

	private static void printDeviceInfo(UsbDevice device, int indent) throws UsbException, UnsupportedEncodingException {
		StringBuilder sb = new StringBuilder();
		for (int i = 0; i < indent; i++) {
			sb.append(" ");
		}

		sb.append("Device: ");
		sb.append(device);
		sb.append(" (ID: ").append(device.getUsbDeviceDescriptor().idVendor()).append(":")
				.append(device.getUsbDeviceDescriptor().idProduct()).append(")");

		UsbStringDescriptor manufacturer = device.getUsbDeviceDescriptor().iManufacturer() != 0
				? (device).getUsbStringDescriptor(device.getUsbDeviceDescriptor().iManufacturer())
				: null;
		if (manufacturer != null) {
			sb.append(" - Manufacturer: ").append(manufacturer.getString());
		}

		UsbStringDescriptor product = device.getUsbDeviceDescriptor().iProduct() != 0
				? device.getUsbStringDescriptor(device.getUsbDeviceDescriptor().iProduct())
				: null;
		if (product != null) {
			sb.append(" - Product: ").append(product.getString());
		}

		System.out.println(sb.toString());
	}

	public static UsbDevice findDevice(UsbHub hub, short vendorId, short productId) {
		for (UsbDevice device : (List<UsbDevice>) hub.getAttachedUsbDevices()) {
			UsbDeviceDescriptor desc = device.getUsbDeviceDescriptor();
			if (desc.idVendor() == vendorId && desc.idProduct() == productId)
				return device;
			if (device.isUsbHub()) {
				device = findDevice((UsbHub) device, vendorId, productId);
				if (device != null) {
					return device;
				} else {
					System.err.println("Could not find the device!");
				}
			}
		}
		return null;
	}

	public static String getVendorName(UsbDevice device)
			throws UsbDisconnectedException, UsbException, UnsupportedEncodingException {
		UsbStringDescriptor vendorString = device
				.getUsbStringDescriptor((byte) device.getUsbDeviceDescriptor().iManufacturer());
		return (vendorString != null) ? vendorString.getString() : "Unknown Vendor";
	}

	public static String getProductName(UsbDevice device)
			throws UsbDisconnectedException, UsbException, UnsupportedEncodingException {
		UsbStringDescriptor productString = device
				.getUsbStringDescriptor((byte) device.getUsbDeviceDescriptor().iProduct());
		return (productString != null) ? productString.getString() : "Unknown Product";
	}
}
