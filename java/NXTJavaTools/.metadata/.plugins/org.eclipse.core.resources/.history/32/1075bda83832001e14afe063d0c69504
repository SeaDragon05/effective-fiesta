package main;

import java.io.UnsupportedEncodingException;
import java.nio.ByteBuffer;
import java.util.List;
import java.util.Scanner;

import javax.usb.*;

import org.usb4java.Context;
import org.usb4java.Device;
import org.usb4java.DeviceDescriptor;
import org.usb4java.DeviceHandle;
import org.usb4java.DeviceList;
import org.usb4java.LibUsb;
import org.usb4java.LibUsbException;
import org.usb4java.Loader;

public class test {
	public static void main(String[] args) throws SecurityException, UsbException {
		Scanner scnr = new Scanner(System.in);
		System.out.println("Enter the Bus number of the device: ");
		int bus = scnr.nextInt();
		System.out.println("Enter the device number of the device: ");
		int device = scnr.nextInt();

		LibUsb.init(null);//w a t
		DeviceHandle handle = new DeviceHandle();
		Context context = new Context();
		int result = LibUsb.init(context);
		if (result < 0) {
			throw new LibUsbException("that didn't work", result);
		}
		
		DeviceList list = new DeviceList();
		
		result = LibUsb.getDeviceList(context, list);
        if (result < 0) {
            throw new LibUsbException("Unable to get device list", result);
        }

		Device NXT = null;//LibUsb.getDeviceByBusNumberAndAddress(context, bus, device);
		
		try {
			for (Device dev : list) {

                DeviceDescriptor descriptor = new DeviceDescriptor();
                result = LibUsb.getDeviceDescriptor(dev, descriptor);
                if (result != LibUsb.SUCCESS) {
                    throw new LibUsbException("Unable to read device descriptor", result);
                }

                if (LibUsb.getBusNumber(dev) == bus && LibUsb.getDeviceAddress(dev) == device) {
                    NXT = dev;
                    break;
                }
			}
		} catch (Exception e) {
			
		}
		
		
		
		if (NXT == null) {
            throw new RuntimeException("USB device not found");
        }
        
		result = LibUsb.open(NXT, handle);
        if (result != LibUsb.SUCCESS) {
            throw new LibUsbException("Unable to open USB device", result);
        }
        
        ByteBuffer dataToSend = Main.playTone(500, 100);
        
        int transferred = LibUsb.controlTransfer(handle,
                (byte) (LibUsb.REQUEST_TYPE_CLASS | LibUsb.RECIPIENT_INTERFACE),
                (byte) 0x09, // bRequest (SET_REPORT)
                (short) 0x200, // wValue (Report type and ID)
                (short) 0x00, // wIndex (Interface number)
                dataToSend,
                1000); // Timeout in milliseconds

        if (transferred < 0) {
            throw new LibUsbException("Control transfer failed", transferred);
        }

        
	}

	private static void listConnectedDevices(UsbHub hub, int indent) throws UsbException, UnsupportedEncodingException {
		for (UsbDevice device : (List<UsbDevice>) hub.getAttachedUsbDevices()) {
			printDeviceInfo(device, indent);
			if (device.isUsbHub()) {
				listConnectedDevices((UsbHub) device, indent + 2);
			}
		}
	}

	private static void printDeviceInfo(UsbDevice device, int indent) throws UsbException, UnsupportedEncodingException {
		StringBuilder sb = new StringBuilder();
		for (int i = 0; i < indent; i++) {
			sb.append(" ");
		}

		sb.append("Device: ");
		sb.append(device);
		sb.append(" (ID: ").append(device.getUsbDeviceDescriptor().idVendor()).append(":")
				.append(device.getUsbDeviceDescriptor().idProduct()).append(")");

		UsbStringDescriptor manufacturer = device.getUsbDeviceDescriptor().iManufacturer() != 0
				? (device).getUsbStringDescriptor(device.getUsbDeviceDescriptor().iManufacturer())
				: null;
		if (manufacturer != null) {
			sb.append(" - Manufacturer: ").append(manufacturer.getString());
		}

		UsbStringDescriptor product = device.getUsbDeviceDescriptor().iProduct() != 0
				? device.getUsbStringDescriptor(device.getUsbDeviceDescriptor().iProduct())
				: null;
		if (product != null) {
			sb.append(" - Product: ").append(product.getString());
		}

		System.out.println(sb.toString());
	}

	public static UsbDevice findDevice(UsbHub hub, short vendorId, short productId) {
		for (UsbDevice device : (List<UsbDevice>) hub.getAttachedUsbDevices()) {
			UsbDeviceDescriptor desc = device.getUsbDeviceDescriptor();
			if (desc.idVendor() == vendorId && desc.idProduct() == productId)
				return device;
			if (device.isUsbHub()) {
				device = findDevice((UsbHub) device, vendorId, productId);
				if (device != null) {
					return device;
				} else {
					System.err.println("Could not find the device!");
				}
			}
		}
		return null;
	}

	public static String getVendorName(UsbDevice device)
			throws UsbDisconnectedException, UsbException, UnsupportedEncodingException {
		UsbStringDescriptor vendorString = device
				.getUsbStringDescriptor((byte) device.getUsbDeviceDescriptor().iManufacturer());
		return (vendorString != null) ? vendorString.getString() : "Unknown Vendor";
	}

	public static String getProductName(UsbDevice device)
			throws UsbDisconnectedException, UsbException, UnsupportedEncodingException {
		UsbStringDescriptor productString = device
				.getUsbStringDescriptor((byte) device.getUsbDeviceDescriptor().iProduct());
		return (productString != null) ? productString.getString() : "Unknown Product";
	}
}
